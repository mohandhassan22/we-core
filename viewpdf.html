<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body{
      font-family:Tahoma, Arial, sans-serif;
      margin:0;
      background:#f8f0ff;
      color:#333
    }
    .header{
      background:#6a1b9a;
      color:#fff;
      padding:12px
    }
    .container{
      max-width:1000px;
      margin:20px auto;
      padding:12px
    }
    .actions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-bottom:15px
    }
    .actions a, .actions button{
      background:#6a1b9a;
      color:#fff;
      padding:8px 12px;
      border-radius:6px;
      text-decoration:none;
      border:none;
      cursor:pointer;
      transition: background 0.3s;
      font-family:Tahoma, Arial, sans-serif;
      font-size:14px;
    }
    .actions a:hover, .actions button:hover{
      background:#8e24aa;
    }
    .actions a[disabled], .actions button[disabled]{
      background:#ccc;
      cursor:not-allowed;
    }
    #viewerWrap{
      background:#fff;
      border:1px solid #ddd;
      border-radius:8px;
      overflow:hidden;
    }
    iframe{
      width:100%;
      height:calc(100vh - 140px);
      border:none;
      display:block;
    }
    #missing{
      text-align:center;
      padding:40px;
      color:#999;
    }
    .loading{
      text-align:center;
      padding:40px;
      color:#6a1b9a;
    }
    .loading i{
      font-size:2em;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @media print {
      * { display: none !important; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <strong>Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</strong>
    </div>
  </div>
  <div class="container">
    <div class="actions">
      <a id="backBtn" href="pdf.html"><i class="fas fa-arrow-left"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
      <button id="downloadBtn" type="button"><i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„</button>
      <button id="printBtn" type="button"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>

    <div id="viewerWrap">
      <p id="missing" style="display:none">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù Ù„Ù„Ø¹Ø±Ø¶.</p>
      <div id="loading" class="loading" style="display:none">
        <i class="fas fa-spinner"></i>
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...</p>
      </div>
      <iframe id="pdfViewer" style="display:none"></iframe>
    </div>
  </div>

  <script>
    function getQuery(name){
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    function convertGoogleDriveUrl(url) {
      if (url.includes('drive.google.com')) {
        let fileId = '';
        const match1 = url.match(/\/file\/d\/([^\/]+)/);
        if (match1) fileId = match1[1];
        const match2 = url.match(/[?&]id=([^&]+)/);
        if (match2) fileId = match2[1];
        if (fileId) {
          return `https://drive.google.com/file/d/${fileId}/preview`;
        }
      }
      return url;
    }

    function getDownloadUrl(url) {
      if (url.includes('drive.google.com')) {
        const match = url.match(/\/file\/d\/([^\/]+)/);
        if (match) {
          return `https://drive.google.com/uc?export=download&id=${match[1]}`;
        }
      }
      return url;
    }

    // ===== Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªØ­ØªÙˆÙŠ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ù€ PDF =====
    function printPDF(url) {
      // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 1: ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù€ iframe ÙˆØ·Ø¨Ø§Ø¹ØªÙ‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
      const printWindow = window.open('', '_blank', 'width=900,height=700');
      if (!printWindow) {
        // Ø¥Ø°Ø§ Ù…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù€ popupØŒ Ù†ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±Ø©
        window.open(url, '_blank');
        return;
      }

      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Ø·Ø¨Ø§Ø¹Ø©</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { background: #fff; }
            iframe {
              width: 100vw;
              height: 100vh;
              border: none;
              display: block;
            }
            .toolbar {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              z-index: 9999;
              background: #6a1b9a;
              padding: 8px;
              display: flex;
              gap: 10px;
              justify-content: center;
            }
            .toolbar button {
              background: #fff;
              color: #6a1b9a;
              border: none;
              padding: 7px 18px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              font-weight: bold;
              font-family: Tahoma, Arial, sans-serif;
            }
            .toolbar button.close {
              background: #f44336;
              color: #fff;
            }
            .iframe-wrap {
              margin-top: 48px;
              height: calc(100vh - 48px);
            }
            @media print {
              .toolbar { display: none !important; }
              .iframe-wrap { margin-top: 0; height: 100vh; }
              iframe { width: 100vw; height: 100vh; }
            }
          </style>
        </head>
        <body>
          <div class="toolbar">
            <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¢Ù†</button>
            <button class="close" onclick="window.close()">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
          </div>
          <div class="iframe-wrap">
            <iframe src="${url}" onload=""></iframe>
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
    }

    const src = getQuery('src');
    const viewer = document.getElementById('pdfViewer');
    const missing = document.getElementById('missing');
    const loading = document.getElementById('loading');
    const printBtn = document.getElementById('printBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    if (!src) {
      viewer.style.display = 'none';
      missing.style.display = 'block';
      printBtn.disabled = true;
      downloadBtn.disabled = true;
    } else {
      const originalUrl = decodeURIComponent(src);
      const viewUrl = convertGoogleDriveUrl(originalUrl);

      loading.style.display = 'block';
      viewer.src = viewUrl;

      viewer.onload = function() {
        loading.style.display = 'none';
        viewer.style.display = 'block';
      };

      viewer.onerror = function() {
        loading.style.display = 'none';
        missing.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ø±Ø¶.';
        missing.style.display = 'block';
      };

      // Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ÙŠÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
      printBtn.addEventListener('click', () => {
        printPDF(viewUrl);
      });

      // Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      downloadBtn.addEventListener('click', () => {
        window.open(getDownloadUrl(originalUrl), '_blank');
      });
    }
  </script>
</body>
</html>
