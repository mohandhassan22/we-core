<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body{
      font-family:Tahoma, Arial, sans-serif;
      margin:0;
      background:#f8f0ff;
      color:#333
    }
    .header{
      background:#6a1b9a;
      color:#fff;
      padding:12px
    }
    .container{
      max-width:1000px;
      margin:20px auto;
      padding:12px
    }
    .actions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-bottom:15px
    }
    .actions a, .actions button{
      background:#6a1b9a;
      color:#fff;
      padding:8px 12px;
      border-radius:6px;
      text-decoration:none;
      border:none;
      cursor:pointer;
      transition: background 0.3s;
      font-family:Tahoma, Arial, sans-serif;
      font-size:14px;
    }
    .actions a:hover, .actions button:hover{ background:#8e24aa; }
    .actions button[disabled]{ background:#ccc; cursor:not-allowed; }
    #viewerWrap{
      background:#fff;
      border:1px solid #ddd;
      border-radius:8px;
      overflow:hidden;
    }
    iframe{
      width:100%;
      height:calc(100vh - 140px);
      border:none;
      display:block;
    }
    #missing{
      text-align:center;
      padding:40px;
      color:#999;
    }
    .loading{
      text-align:center;
      padding:40px;
      color:#6a1b9a;
    }
    .loading i{
      font-size:2em;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <strong>Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</strong>
    </div>
  </div>
  <div class="container">
    <div class="actions">
      <a id="backBtn" href="pdf.html"><i class="fas fa-arrow-left"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
      <button id="downloadBtn" type="button"><i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„</button>
      <button id="printBtn" type="button"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>

    <div id="viewerWrap">
      <p id="missing" style="display:none">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù Ù„Ù„Ø¹Ø±Ø¶.</p>
      <div id="loading" class="loading">
        <i class="fas fa-spinner"></i>
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...</p>
      </div>
      <iframe id="pdfViewer" style="display:none"></iframe>
    </div>
  </div>

  <script>
    function getQuery(name){
      return new URLSearchParams(window.location.search).get(name);
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ File ID Ù…Ù† Ø±Ø§Ø¨Ø· Google Drive
    function getFileId(url) {
      const match = url.match(/\/file\/d\/([^\/\?&]+)/);
      return match ? match[1] : null;
    }

    // Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©
    function getPreviewUrl(url) {
      const id = getFileId(url);
      if (id) return `https://drive.google.com/file/d/${id}/preview`;
      return url;
    }

    // Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
    function getDownloadUrl(url) {
      const id = getFileId(url);
      if (id) return `https://drive.google.com/uc?export=download&id=${id}`;
      return url;
    }

    // Ø±Ø§Ø¨Ø· Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø¨Ø± Google Docs Viewer (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)
    function getPrintUrl(url) {
      const id = getFileId(url);
      if (id) {
        // Google Drive ÙŠÙˆÙØ± Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
        return `https://drive.google.com/file/d/${id}/preview?print=true`;
      }
      return url;
    }

    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    function openPrintWindow(fileId) {
      // Ù†ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨ØµÙØ­Ø© HTML Ø¨Ø³ÙŠØ·Ø© ØªØ­Ù…Ù„ Ø§Ù„Ù€ PDF ÙˆØªØ·Ø¨Ø¹Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      const printUrl = `https://drive.google.com/file/d/${fileId}/preview`;
      
      const printWin = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
      if (!printWin) {
        alert('Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù€ Popups Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
        return;
      }

      printWin.document.write(`<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ø·Ø¨Ø§Ø¹Ø©</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: Tahoma, sans-serif; background:#fff; }
    
    #toolbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #6a1b9a;
      padding: 10px;
      display: flex;
      gap: 10px;
      justify-content: center;
      z-index: 9999;
    }
    #toolbar button {
      padding: 8px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: Tahoma, sans-serif;
      font-size: 14px;
      font-weight: bold;
    }
    .btn-print { background: #fff; color: #6a1b9a; }
    .btn-print:hover { background: #f3e5ff; }
    .btn-close { background: #f44336; color: #fff; }
    .btn-close:hover { background: #c62828; }

    #msg {
      text-align: center;
      padding: 15px;
      margin-top: 55px;
      color: #666;
      font-size: 13px;
    }

    #pdfFrame {
      position: fixed;
      top: 50px; left: 0; right: 0; bottom: 0;
      width: 100%;
      height: calc(100vh - 50px);
      border: none;
    }

    @media print {
      #toolbar { display: none !important; }
      #msg { display: none !important; }
      #pdfFrame {
        position: fixed !important;
        top: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
      }
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <button class="btn-print" onclick="startPrint()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¢Ù†</button>
    <button class="btn-close" onclick="window.close()">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <iframe id="pdfFrame" src="${printUrl}"></iframe>

  <script>
    function startPrint() {
      // Ù†Ø­Ø§ÙˆÙ„ Ù†Ø·Ø¨Ø¹ Ù…Ù† iframe
      var frame = document.getElementById('pdfFrame');
      try {
        frame.contentWindow.focus();
        frame.contentWindow.print();
      } catch(e) {
        // CORS Ù…Ù†Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ù† iframeØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©
        // Ù†ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ ØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
        window.open('https://drive.google.com/uc?export=download&id=${fileId}', '_blank');
        alert('ØªÙ… ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù„Ù„ØªØ­Ù…ÙŠÙ„. Ø¨Ø¹Ø¯ ÙØªØ­Ù‡ Ø§Ø¶ØºØ· Ctrl+P Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.');
      }
    }
  <\/script>
</body>
</html>`);
      printWin.document.close();
    }

    // =================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ===================
    const src = getQuery('src');
    const viewer = document.getElementById('pdfViewer');
    const missing = document.getElementById('missing');
    const loading = document.getElementById('loading');
    const printBtn = document.getElementById('printBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    if (!src) {
      loading.style.display = 'none';
      missing.style.display = 'block';
      printBtn.disabled = true;
      downloadBtn.disabled = true;
    } else {
      const originalUrl = decodeURIComponent(src);
      const fileId = getFileId(originalUrl);
      const previewUrl = getPreviewUrl(originalUrl);

      viewer.src = previewUrl;

      viewer.onload = function() {
        loading.style.display = 'none';
        viewer.style.display = 'block';
      };

      viewer.onerror = function() {
        loading.style.display = 'none';
        missing.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù.';
        missing.style.display = 'block';
      };

      // Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
      printBtn.addEventListener('click', () => {
        if (fileId) {
          openPrintWindow(fileId);
        } else {
          alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.');
        }
      });

      // Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      downloadBtn.addEventListener('click', () => {
        window.open(getDownloadUrl(originalUrl), '_blank');
      });
    }
  </script>
</body>
</html>
