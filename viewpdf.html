<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>عرض النموذج</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body{
      font-family:Tahoma, Arial, sans-serif;
      margin:0;
      background:#f8f0ff;
      color:#333
    }
    .header{
      background:#6a1b9a;
      color:#fff;
      padding:12px
    }
    .container{
      max-width:1000px;
      margin:20px auto;
      padding:12px
    }
    .actions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-bottom:15px
    }
    .actions a, .actions button{
      background:#6a1b9a;
      color:#fff;
      padding:8px 12px;
      border-radius:6px;
      text-decoration:none;
      border:none;
      cursor:pointer;
      transition: background 0.3s;
    }
    .actions a:hover, .actions button:hover{
      background:#8e24aa;
    }
    .actions a[disabled], .actions button[disabled]{
      background:#ccc;
      cursor:not-allowed;
    }
    #viewerWrap{
      background:#fff;
      border:1px solid #ddd;
      border-radius:8px;
      overflow:hidden;
    }
    iframe{
      width:100%;
      height:calc(100vh - 140px);
      border:none;
      display:block;
    }
    #missing{
      text-align:center;
      padding:40px;
      color:#999;
    }
    .loading{
      text-align:center;
      padding:40px;
      color:#6a1b9a;
    }
    .loading i{
      font-size:2em;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <strong>عرض النموذج</strong>
    </div>
  </div>
  <div class="container">
    <div class="actions">
      <a id="backBtn" href="pdf.html"><i class="fas fa-arrow-left"></i> العودة</a>
      <button id="downloadBtn" type="button"><i class="fas fa-download"></i> تحميل</button>
      <button id="printBtn" type="button"><i class="fas fa-print"></i> طباعة</button>
    </div>

    <div id="viewerWrap">
      <p id="missing" style="display:none">لم يتم تحديد ملف للعرض.</p>
      <div id="loading" class="loading" style="display:none">
        <i class="fas fa-spinner"></i>
        <p>جاري تحميل الملف...</p>
      </div>
      <iframe id="pdfViewer" style="display:none"></iframe>
    </div>
  </div>

  <script>
    function getQuery(name){
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // تحويل رابط Google Drive للعرض المباشر
    function convertGoogleDriveUrl(url) {
      // إذا كان الرابط من Google Drive
      if (url.includes('drive.google.com')) {
        // استخراج معرف الملف
        let fileId = '';
        
        // نمط 1: https://drive.google.com/file/d/FILE_ID/view
        const match1 = url.match(/\/file\/d\/([^\/]+)/);
        if (match1) {
          fileId = match1[1];
        }
        
        // نمط 2: https://drive.google.com/open?id=FILE_ID
        const match2 = url.match(/[?&]id=([^&]+)/);
        if (match2) {
          fileId = match2[1];
        }
        
        if (fileId) {
          // استخدام رابط المعاينة المباشرة
          return `https://drive.google.com/file/d/${fileId}/preview`;
        }
      }
      
      return url;
    }

    const src = getQuery('src');
    const viewer = document.getElementById('pdfViewer');
    const missing = document.getElementById('missing');
    const loading = document.getElementById('loading');
    const printBtn = document.getElementById('printBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    if (!src) {
      viewer.style.display = 'none';
      missing.style.display = 'block';
      printBtn.disabled = true;
      downloadBtn.disabled = true;
    } else {
      const originalUrl = decodeURIComponent(src);
      const viewUrl = convertGoogleDriveUrl(originalUrl);
      
      // عرض شاشة التحميل
      loading.style.display = 'block';
      
      // تحميل الملف في iframe
      viewer.src = viewUrl;
      
      // عند انتهاء التحميل
      viewer.onload = function() {
        loading.style.display = 'none';
        viewer.style.display = 'block';
      };

      // في حالة فشل التحميل
      viewer.onerror = function() {
        loading.style.display = 'none';
        missing.textContent = 'حدث خطأ في تحميل الملف. تأكد من أن الملف متاح للعرض.';
        missing.style.display = 'block';
      };

      // زر الطباعة
      printBtn.addEventListener('click', () => {
        try {
          // محاولة الطباعة من iframe
          const iframeWindow = viewer.contentWindow;
          if (iframeWindow) {
            iframeWindow.focus();
            iframeWindow.print();
          } else {
            // في حالة عدم القدرة على الوصول لـ iframe، فتح في نافذة جديدة
            window.open(viewUrl, '_blank');
          }
        } catch(e) {
          // إذا كان هناك مشكلة في CORS، فتح في نافذة جديدة
          alert('سيتم فتح الملف في نافذة جديدة للطباعة');
          window.open(viewUrl, '_blank');
        }
      });

      // زر التحميل
      downloadBtn.addEventListener('click', () => {
        // تحويل الرابط لرابط تحميل مباشر
        let downloadUrl = originalUrl;
        
        if (originalUrl.includes('drive.google.com')) {
          const match = originalUrl.match(/\/file\/d\/([^\/]+)/);
          if (match) {
            const fileId = match[1];
            downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
          }
        }
        
        // فتح رابط التحميل
        window.open(downloadUrl, '_blank');
      });
    }
  </script>
</body>

</html>

