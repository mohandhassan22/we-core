<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>عرض النموذج</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body{
      font-family:Tahoma, Arial, sans-serif;
      margin:0;
      background:#f8f0ff;
      color:#333
    }
    .header{
      background:#6a1b9a;
      color:#fff;
      padding:12px
    }
    .container{
      max-width:1000px;
      margin:20px auto;
      padding:12px
    }
    .actions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-bottom:15px
    }
    .actions a, .actions button{
      background:#6a1b9a;
      color:#fff;
      padding:8px 12px;
      border-radius:6px;
      text-decoration:none;
      border:none;
      cursor:pointer;
      transition: background 0.3s;
      font-family:Tahoma, Arial, sans-serif;
      font-size:14px;
    }
    .actions a:hover, .actions button:hover{
      background:#8e24aa;
    }
    .actions a[disabled], .actions button[disabled]{
      background:#ccc;
      cursor:not-allowed;
    }
    #viewerWrap{
      background:#fff;
      border:1px solid #ddd;
      border-radius:8px;
      overflow:hidden;
    }
    iframe{
      width:100%;
      height:calc(100vh - 140px);
      border:none;
      display:block;
    }
    #missing{
      text-align:center;
      padding:40px;
      color:#999;
    }
    .loading{
      text-align:center;
      padding:40px;
      color:#6a1b9a;
    }
    .loading i{
      font-size:2em;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* ======= صفحة الطباعة ======= */
    #printOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: #fff;
      z-index: 9999;
      flex-direction: column;
    }
    #printOverlay.active {
      display: flex;
    }
    #printOverlay iframe {
      flex: 1;
      width: 100%;
      border: none;
    }
    #printToolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      padding: 10px;
      background: #6a1b9a;
    }
    #printToolbar button {
      background: #fff;
      color: #6a1b9a;
      border: none;
      padding: 8px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-family: Tahoma, Arial, sans-serif;
      font-size: 14px;
      font-weight: bold;
    }
    #printToolbar button:hover {
      background: #f3e5ff;
    }
    #printToolbar .close-btn {
      background: #f44336;
      color: #fff;
    }
    #printToolbar .close-btn:hover {
      background: #d32f2f;
    }

    @media print {
      /* إخفاء كل شيء عدا الـ iframe في overlay */
      body > * { display: none !important; }
      #printOverlay {
        display: block !important;
        position: fixed !important;
        inset: 0 !important;
      }
      #printToolbar { display: none !important; }
      #printOverlay iframe {
        width: 100vw !important;
        height: 100vh !important;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <strong>عرض النموذج</strong>
    </div>
  </div>
  <div class="container">
    <div class="actions">
      <a id="backBtn" href="pdf.html"><i class="fas fa-arrow-left"></i> العودة</a>
      <button id="downloadBtn" type="button"><i class="fas fa-download"></i> تحميل</button>
      <button id="printBtn" type="button"><i class="fas fa-print"></i> طباعة</button>
    </div>

    <div id="viewerWrap">
      <p id="missing" style="display:none">لم يتم تحديد ملف للعرض.</p>
      <div id="loading" class="loading" style="display:none">
        <i class="fas fa-spinner"></i>
        <p>جاري تحميل الملف...</p>
      </div>
      <iframe id="pdfViewer" style="display:none"></iframe>
    </div>
  </div>

  <!-- طبقة الطباعة المخصصة -->
  <div id="printOverlay">
    <div id="printToolbar">
      <button onclick="doPrint()"><i class="fas fa-print"></i> طباعة الآن</button>
      <button class="close-btn" onclick="closePrint()"><i class="fas fa-times"></i> إغلاق</button>
    </div>
    <iframe id="printFrame"></iframe>
  </div>

  <script>
    function getQuery(name){
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // تحويل رابط Google Drive للعرض المباشر
    function convertGoogleDriveUrl(url) {
      if (url.includes('drive.google.com')) {
        let fileId = '';
        const match1 = url.match(/\/file\/d\/([^\/]+)/);
        if (match1) fileId = match1[1];
        const match2 = url.match(/[?&]id=([^&]+)/);
        if (match2) fileId = match2[1];
        if (fileId) {
          return `https://drive.google.com/file/d/${fileId}/preview`;
        }
      }
      return url;
    }

    // استخراج رابط التحميل المباشر
    function getDownloadUrl(url) {
      if (url.includes('drive.google.com')) {
        const match = url.match(/\/file\/d\/([^\/]+)/);
        if (match) {
          return `https://drive.google.com/uc?export=download&id=${match[1]}`;
        }
      }
      return url;
    }

    const src = getQuery('src');
    const viewer = document.getElementById('pdfViewer');
    const missing = document.getElementById('missing');
    const loading = document.getElementById('loading');
    const printBtn = document.getElementById('printBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const printOverlay = document.getElementById('printOverlay');
    const printFrame = document.getElementById('printFrame');

    if (!src) {
      viewer.style.display = 'none';
      missing.style.display = 'block';
      printBtn.disabled = true;
      downloadBtn.disabled = true;
    } else {
      const originalUrl = decodeURIComponent(src);
      const viewUrl = convertGoogleDriveUrl(originalUrl);

      // عرض شاشة التحميل
      loading.style.display = 'block';

      viewer.src = viewUrl;

      viewer.onload = function() {
        loading.style.display = 'none';
        viewer.style.display = 'block';
      };

      viewer.onerror = function() {
        loading.style.display = 'none';
        missing.textContent = 'حدث خطأ في تحميل الملف. تأكد من أن الملف متاح للعرض.';
        missing.style.display = 'block';
      };

      // ===== زر الطباعة: يفتح overlay داخل نفس الصفحة =====
      printBtn.addEventListener('click', () => {
        // تحميل الـ PDF في iframe الطباعة
        printFrame.src = viewUrl;
        printOverlay.classList.add('active');
      });

      // ===== زر التحميل =====
      downloadBtn.addEventListener('click', () => {
        window.open(getDownloadUrl(originalUrl), '_blank');
      });
    }

    // طباعة من داخل الـ overlay
    function doPrint() {
      // محاولة الطباعة من iframe
      try {
        printFrame.contentWindow.focus();
        printFrame.contentWindow.print();
      } catch(e) {
        // إذا منع CORS نستخدم window.print مع إخفاء باقي الصفحة
        window.print();
      }
    }

    // إغلاق الـ overlay
    function closePrint() {
      printOverlay.classList.remove('active');
      printFrame.src = '';
    }
  </script>
</body>
  </html>
  
